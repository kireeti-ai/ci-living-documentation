name: EPIC-2 Documentation Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    env:
      # EPIC-1
      TARGET_REPO_URL: ${{ secrets.TARGET_REPO_URL }}
      TARGET_REPO_BRANCH: main
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # R2 Storage
      R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}

    steps:
      # 1Ô∏è‚É£ Checkout EPIC-2 repo
      - name: Checkout EPIC-2 repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r sprint1/requirements.txt

      # 4Ô∏è‚É£ Run EPIC-2 (auto-fetches EPIC-1 report)
      - name: Run EPIC-2 Documentation Generator
        run: |
          python -m sprint1.src.run_epic2

      # 5Ô∏è‚É£ Upload docs as GitHub artifact (debug + audit)
      - name: Upload generated docs (GitHub artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: epic2-docs
          path: sprint1/artifacts/docs

      # 6Ô∏è‚É£ Summary
      - name: Pipeline summary
        run: |
          echo "‚úÖ EPIC-2 documentation generated successfully"
          echo "üì¶ Uploaded to R2 bucket: $R2_BUCKET_NAME"
