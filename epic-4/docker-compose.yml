services:
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - REPO_OWNER=${REPO_OWNER}
      - REPO_NAME=${REPO_NAME}
      - TARGET_BRANCH=${TARGET_BRANCH:-main}
      # Cloudflare R2 (optional)
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - DOCS_BUCKET_PATH=${DOCS_BUCKET_PATH}
    volumes:
      - ./artifacts:/app/artifacts
    restart: always

  # Optional: CLI companion for easier experimentation
  cli:
    build: .
    entrypoint: python -m epic4.run
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - REPO_OWNER=${REPO_OWNER}
      - REPO_NAME=${REPO_NAME}
      - TARGET_BRANCH=${TARGET_BRANCH:-main}
      - COMMIT_SHA=${COMMIT_SHA}
      # Cloudflare R2 (optional)
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - DOCS_BUCKET_PATH=${DOCS_BUCKET_PATH}
    volumes:
      - ./artifacts:/app/artifacts
